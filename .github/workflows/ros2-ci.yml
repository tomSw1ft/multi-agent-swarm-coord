name: ROS 2 CI with Pixi

# Triggers the workflow on push or pull request events
# for the "main" branch
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    # Runs the job on the latest Ubuntu version
    runs-on: ubuntu-latest
    
    # Uses the official ROS 2 Jazzy Docker container
    # This provides a clean environment with ROS 2 pre-installed
    container: ros:jazzy

    steps:
      # Step 1: Checks out your repository's code
      - name: Check out repository
        uses: actions/checkout@v4

      # Step 2: Installs the Pixi package manager
      - name: Install Pixi
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          post-cleanup: false

      # Step 3: Installs all dependencies from pixi.toml/pixi.lock
      - name: Install project dependencies
        run: pixi install

      # Step 4: Builds the ROS 2 workspace using colcon
      # 'pixi shell -c' runs the command inside the Pixi environment
      - name: Build ROS 2 Workspace
        run: pixi shell -c "colcon build --symlink-install --event-handlers console_direct+"

      # Step 5: Runs the ROS 2 tests
      # This command first sources the new setup files, then runs the tests,
      # all within the same Pixi-activated shell.
      - name: Run ROS 2 Tests
        run: |
          pixi shell -c "source install/setup.bash && colcon test --event-handlers console_direct+"